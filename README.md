# 坦克大战后端接口文档

## 目录

- [接口地址](#接口地址)
- [连接流程](#连接流程)
- [消息格式](#消息格式)
- [消息类型](#消息类型)
- [Payload 字段说明](#payload-字段说明)
  - [type=0 提示消息](#type0-提示消息)
  - [type=1 连接建立后初始化数据](#type1-连接建立后初始化数据)
  - [type=2 游戏状态广播](#type2-游戏状态广播)
  - [type=3 射击事件广播](#type3-射击事件广播)
  - [type=4 错误提示](#type4-错误提示)
  - [type=7 命中事件广播](#type7-命中事件广播)
  - [type=15 坦克操作指令](#type15-坦克操作指令)
  - [type=16 注册请求](#type16-注册请求)
  - [type=17 命中通知](#type17-命中通知)
- [方向代码说明](#方向代码说明)

---

## 接口地址

| 功能         | 地址                                 |
|--------------|--------------------------------------|
| 玩家接入游戏 | `ws://192.168.10.94:8888/ws`         |
| 最新测试页面 | `ws://192.168.10.94:8887/ws`         |
| 地图阅览     | `ws://192.168.10.94:8887/mapws`      |

---

## 连接流程

1. 客户端通过 WebSocket 连接到服务器：  
   `ws://192.168.10.233:8888/ws`
2. 连接成功后，服务端发送提示消息：
   ```json
   {
     "type": 0,
     "id": "perpartext",
     "payload": {
       "notice": "websocket connect success"
     }
   }
   ```
3. 客户端收到后需在规定时间内发送注册请求：
   ```json
   {
     "type": 16,
     "id": "",
     "payload": {
       "username": "你的用户名",
       "success": true
     }
   }
   ```
4. 注册失败（用户名为空或重复）时，服务端返回：
   ```json
   {
     "type": 4,
     "id": "用户名",
     "payload": {
       "notice": "username is empty or already exists"
     }
   }
   ```
5. 注册成功后，服务端返回地图和玩家初始信息（见 [type=1](#type1-连接建立后初始化数据)）。

---

## 消息格式

所有消息均为 JSON 格式，结构如下：

```json
{
  "type": 15,
  "id": "4e3a8178-4f1b-44ff-959f-197f7ca84979",
  "payload": { ... }
}
```

| 字段名   | 说明           | 类型         |
|----------|----------------|-------------|
| type     | 消息类型       | int         |
| id       | 通信目标       | string      |
| payload  | 消息内容       | object      |

---

## 消息类型

### 服务端发送 (type < 15)

| type | 说明               |
|------|--------------------|
| 0    | 提示消息           |
| 1    | 连接建立后初始化数据|
| 2    | 游戏状态广播       |
| 3    | 射击事件广播       |
| 4    | 错误提示           |
| 5    | 击中事件广播       |
| 7    | 命中事件广播       |

### 客户端发送 (type >= 15)

| type | 说明         |
|------|--------------|
| 15   | 坦克操作指令 |
| 16   | 注册请求     |
| 17   | 命中通知     |

---

## Payload 字段说明

### type=0 提示消息

```json
{
  "type": 0,
  "id": "perpartext",
  "payload": {
    "notice": "websocket connect success"
  }
}
```
| 字段名 | 说明     | 类型   |
|--------|----------|--------|
| notice | 提示内容 | string |

---

### type=1 连接建立后初始化数据

```json
{
  "type": 1,
  "id": "用户名",
  "payload": {
    "map": "AQEBAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
    "map_size_x": 30,
    "map_size_y": 30,
    "tank_coord_x": 1,
    "tank_coord_y": 1,
    "tank_facing": 2,
    "tick_interval_ms": 50,
    "map_render_ms": 500,
    "username": "QAQ-555"
  }
}
```
| 字段名         | 说明           | 取值及含义                                                                 |
|----------------|----------------|----------------------------------------------------------------------------|
| map            | 地图序列字节流 | 字符串，地图数据序列化                                                     |
| map_size_x     | 地图宽度       | 正整数，地图的宽度（格子数）                                               |
| map_size_y     | 地图高度       | 正整数，地图的高度（格子数）                                               |
| tank_coord_x   | 坦克x坐标      | 正整数，坦克出生点x坐标                                                    |
| tank_coord_y   | 坦克y坐标      | 正整数，坦克出生点y坐标                                                    |
| tank_facing    | 坦克面向       | 1~9，见[方向代码说明](#方向代码说明)                                       |
| tick_interval_ms | 广播间隔(ms) | 正整数，服务端广播状态的时间间隔（毫秒）                                   |
| map_render_ms  | 地图刷新率(ms) | 正整数，地图刷新间隔（毫秒）                                               |
| username       | 注册用户名     | 字符串，当前玩家用户名                                                     |

---

### type=2 游戏状态广播

```json
{
  "type": 2,
  "id": "broadcast message gamer",
  "payload": {
    "tanks": [
      {
        "x": 1,
        "y": 1,
        "reload": 0,
        "trigger": false,
        "gunfacing": 2,
        "status": 1,
        "orientation": 5,
        "id": "ae9f7384-02b5-4407-8bab-4203beffc13a"
      }
    ]
  }
}
```
| 字段名      | 说明         | 取值及含义                                                                 |
|-------------|--------------|----------------------------------------------------------------------------|
| x           | 坦克x坐标    | 正整数，坦克当前x坐标                                                      |
| y           | 坦克y坐标    | 正整数，坦克当前y坐标                                                      |
| reload      | 发射冷却     | 正整数，距离下次可发射的剩余时间（单位ms）                                 |
| trigger     | 扳机状态     | `true`/`false`，是否按下开火                                               |
| gunfacing   | 炮管面向     | 1~9，见[方向代码说明](#方向代码说明)                                       |
| status      | 坦克状态     | 0=空闲，1=已占用                                                           |
| orientation | 前进方向     | 1~9，见[方向代码说明](#方向代码说明)                                       |
| id          | 坦克ID/用户名| 字符串，坦克所属玩家用户名                                                 |

---

### type=3 射击事件广播

```json
{
  "type": 3,
  "id": "broadcast message gamer",
  "payload": {
    "username": "888",
    "x": 68,
    "y": 73,
    "orientation": 2
  }
}
```
| 字段名    | 说明               | 取值及含义                                                                 |
|-----------|--------------------|----------------------------------------------------------------------------|
| username  | 发起射击用户名     | 字符串                                                                     |
| x         | 发射位置x坐标      | 正整数                                                                     |
| y         | 发射位置y坐标      | 正整数                                                                     |
| orientation | 发射方向         | 1~9，见[方向代码说明](#方向代码说明)                                       |

---

### type=4 错误提示

```json
{
  "type": 4,
  "id": "...",
  "payload": {
    "notice": "error message"
  }
}
```
| 字段名 | 说明     | 取值及含义             |
|--------|----------|------------------------|
| notice | 错误内容 | 字符串，错误提示内容   |

---

### type=7 命中事件广播

```json
{
  "type": 7,
  "id": "broadcast message gamer",
  "payload": {
    "username": "qaq555",
    "victim": "2222"
  }
}
```
| 字段名   | 说明                   | 取值及含义             |
|----------|------------------------|------------------------|
| username | 发起命中事件用户名     | 字符串                 |
| victim   | 被击中用户的ID         | 字符串                 |

---

### type=15 坦克操作指令

```json
{
  "type": 15,
  "id": "<客户端ID>",
  "payload": {
    "up": true,
    "down": false,
    "left": false,
    "right": true,
    "action": "fire"
  }
}
```
| 字段名 | 说明         | 取值及含义                                                                 |
|--------|--------------|----------------------------------------------------------------------------|
| up     | 上移动信号   | `true`/`false`，是否向上移动                                               |
| down   | 下移动信号   | `true`/`false`，是否向下移动                                               |
| left   | 左移动信号   | `true`/`false`，是否向左移动                                               |
| right  | 右移动信号   | `true`/`false`，是否向右移动                                               |
| action | 坦克行动     | `"fire"`=开火，留空或其他为无操作                                         |

---

### type=16 注册请求

```json
{
  "type": 16,
  "id": "",
  "payload": {
    "username": "888",
    "success": true
  }
}
```
| 字段名   | 说明         | 取值及含义                     |
|----------|--------------|--------------------------------|
| username | 注册用户名   | 字符串                         |
| success  | 是否成功接收 | `true`=成功，`false`=失败      |

---

### type=17 命中通知

```json
{
  "type": 17,
  "id": "sss",
  "payload": {
    "username": "1111",
    "victim": "cxzcz"
  }
}
```
| 字段名   | 说明                         | 取值及含义             |
|----------|------------------------------|------------------------|
| username | 通知发起用户（命中检测方）   | 字符串                 |
| victim   | 被击中用户的ID               | 字符串                 |

---

## 方向代码说明

游戏状态广播中 `gunfacing` 与 `orientation` 字段采用如下方向代码：

```
7 8 9
4 5 6
1 2 3
```

| 代码 | 方向   |
|------|--------|
| 7    | 左上   |
| 8    | 上     |
| 9    | 右上   |
| 4    | 左     |
| 5    | 静止   |
| 6    | 右     |
| 1    | 左下   |
| 2    | 下     |
| 3    | 右下   |

---

如需补充其他细节或示例，请补充


